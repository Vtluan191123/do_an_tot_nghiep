# ===================================================================
# Spring Boot configuration.
#
# This configuration will be overridden by the Spring profile you use
# For example: application-dev.yml if you use the "dev" profile.
# ===================================================================

# ===================================================================
# Standard Spring Boot properties.
# Full reference is available at:
# https://docs.spring.io/spring-boot/reference/features/profiles.html
# ===================================================================

logging:
  level:
    root: debug
    sds.easypos.gateway: debug
    io.netty: info
    io.lettuce.core.protocol: info
    io.github.resilience4j: info
    reactor.netty.transport: info
    org.springframework.web.socket: debug
  charset:
    console: UTF-8
    file: UTF-8
  file:
    path: opt/logs/easypos-gateway-cloud

server:
  port: 8088

spring:
  cloud:
    gateway:
      # The parameters below are relatively dependent on each other
      # Consider before changing because one parameter will affect the remaining parameters
      httpclient:
        # Maximum time (in milliseconds) Gateway waits to open a TCP connection to downstream services
        # This only counts the TCP handshake phase, not the API response time
        connect-timeout: 5000
        # Maximum time Gateway waits for response from downstream services after request has been sent successfully
        # If downstream services does not respond within this time → Gateway disconnects, returns error 504 GATEWAY_TIMEOUT
        response-timeout: 180s
        pool:
          # Maximum number of TCP connections the Gateway can hold open simultaneously to downstream services
          # Reactor Netty uses a connection pool (reuses keep-alive connections) to avoid the overhead of opening new connections
          # This is the total number of connections per host (in Reactor Netty)
          # If the Gateway calls multiple backends, each backend has its own pool
          max-connections: 100
          # When all connections in the pool are busy, the new request will wait up to 3 seconds to borrow a free connection
          # If this time is over and there is no connection → Gateway reports an error
          # With traffic of about 500 requests/s per backend instance and average latency of ~500ms,
          # acquire-timeout = 3s ensures that requests wait for a free connection in the pool for up to 3s
          # before failing, enough for most requests to be processed without disconnection or error
          acquire-timeout: 3000

      # Global request filters
      default-filters:
        - "DedupeResponseHeader=Content-Type Vary \
          Access-Control-Allow-Origin \
          Access-Control-Allow-Credentials \
          Access-Control-Allow-Headers \
          Access-Control-Allow-Methods, RETAIN_LAST"
        - name: AddResponseHeader
          args:
            name: X-Gateway-Downstream
            value: v1

      # Route configurations
      routes:
        - id: product-material-route
          uri: http://localhost:8089
          predicates:
            - Path=/api/client/page/product/**, /api/client/page/product-unit/**, /api/client/page/product-group/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - RemoveResponseHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 30
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 5

        - id: report-service-route
          uri: http://localhost:8386
          predicates:
            - Path=/api/client/page/report2/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - RemoveResponseHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 30
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 5

        - id: bank-service-route
          uri: http://localhost:8603
          predicates:
            - Path=/api/payment-integration/**, /api/sds-bank/**, /api/sds-bank-hkd/**, /api/sds-bank-tcb/**, /api/payment/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - RemoveResponseHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 30
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 15

        - id: pharma-service-route
          uri: http://localhost:8602
          predicates:
            - Path=/api/pharma/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - RemoveResponseHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 30
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 15

        - id: ecommerce-service-route
          uri: http://localhost:8882
          predicates:
            - Path=/api/e-commerce/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - RemoveResponseHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 50
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 15

        - id: integration-gas-route
          uri: http://localhost:8081
          predicates:
            - Path=/api/client/page/gas-log/**, /api/client/integration-mqtt/**, /api/client/integration/**, /api/p/client/integration/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - RemoveResponseHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 30
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 10

        - id: well-known-route
          uri: http://localhost:8080
          predicates:
            - Path=/.well-known/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - RemoveResponseHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 30
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 5

        - id: authenticate-route
          uri: http://localhost:8080
          predicates:
            - Path=/authenticate
          filters:
            - RewritePath=/authenticate(?<segment>.*), /api/client/common/authenticate${segment}
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 15
                rate-limiter.windowSeconds: 60
                rate-limiter.banDurationMinutes: 15

        - id: authenticate-common-route
          uri: http://localhost:8080
          predicates:
            - Path=/api/client/common/authenticate
          filters:
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 10
                rate-limiter.windowSeconds: 60
                rate-limiter.banDurationMinutes: 15

        - id: backend-public-service-route
          uri: http://localhost:8080
          predicates:
            - Path=/api/p/**
          filters:
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 30
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 10

        - id: backend-page-service-route
          uri: http://locahost:8080
          predicates:
            - Path=/api/page/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - RemoveResponseHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 30
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 10

        - id: backend-service-route
          uri: http://localhost:8080
          predicates:
            - Path=/api/client/common/**, /api/client/**, /api/integration/**, /actuator/**
          filters:
            - RemoveRequestHeader=Cookie
            - RemoveRequestHeader=Set-Cookie
            - RemoveResponseHeader=Set-Cookie
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 30
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 15

        - id: management-route
          uri: http://localhost:8080
          predicates:
            - Path=/management/**, /api/client/management/**
          filters:
            - name: CustomRateLimiter
              args:
                rate-limiter.banThreshold: 30
                rate-limiter.windowSeconds: 1
                rate-limiter.banDurationMinutes: 15

      # Metrics configuration
      metrics:
        enabled: true
        tags:
          path:
            enabled: true
          application: ${spring.application.name}
          environment: ${spring.profiles.active}
      observability:
        enabled: true
  # Redis Configuration for Rate Limiting
  data:
    redis:
      host: 10.100.140.9
      port: 6379
      database: 3
      timeout: 100ms
      connect-timeout: 500ms
      lettuce:
        pool:
          enabled: true
          max-active: 5
          max-idle: 2
          min-idle: 2
          max-wait: 1s
          time-between-eviction-runs: 30s
        shutdown-timeout: 100ms
      ssl:
        enabled: false
      channels:
        update-rate-limit-config: update-rate-limit-config
        update-rate-limit-excluded-config: update-rate-limit-excluded-config
        update-security-config: update-security-config

app:
  device-key: MWVkY2JiMjU2YzQxZWM4ZmJiZDU0MTZj # 32 characters
  security:
    rate-limit-excluded-apis:
      - /api/integration/crm/**
      - /api/client/integration/**
      - /api/p/client/integration/**
      - /api/client/common/authenticate
      - /api/client/common/authenticate/**
      - /favicon.ico
      - /api/e-commerce/webhook/notification/**
      - /api/integration/eb/disconnect-eb
      - /authenticate
      - /authenticate/**
    public-request-patterns:
      - /api/client/common/authenticate
      - /api/client/common/authenticate/**
      - /authenticate
      - /authenticate/**
      - /api/authenticate
      - /api/client/common/register/**
      - /api/integration/crm/**
      - /api/client/integration-mqtt/**
      - /api/p/**
      - /favicon.ico
      - /api/integration/eb/disconnect-eb
      - /api/client/integration/atc/pump-gas-log
      - /api/e-commerce/webhook/notification/**
      - /api/sds-bank/**
      - /api/sds-bank-hkd/**
      - /api/client/common/forgot-password
      - /api/account/reset-password/**
      - /api/client/common/reset-password/**
      - /api/integration/send-sms
      - /.well-known/**
      - /api/integration/user/stop-working
      - /actuator/**
      - /api/client/page/config/print-tool-url
      - /robots.txt
      - /
    jwt:
      base64-secret-key: NDdiMDQ3Njg3NjNkMjJjYTVhMDQyNDgwNjhhZjFjOGIxZTQ4OGJkMTE1Mzk5YTcxMWVkY2JiMjU2YzQxZWM4ZmJiZDU0MTZjODJkYWE5MGU0ZDAyNDNiNWViZjJkYWIxYmY2OGZhMjQyOWY4ODJjNTZmYzIxN2ViOTY4OThkNTQ=
  i18n:
    base-names:
      - classpath:i18n/messages
      - classpath:i18n/base_messages
    encoding: UTF-8
  cors:
    activate: enabled
    patterns:
      '[/**]':
        allowedOrigins:
          - "http://10.100.140.9:8080"
          - "http://10.100.140.9:8082"
          - "http://14.225.187.199:8080"
          - "http://14.225.187.199:8082"
          - "http://10.100.140.9:8888"
          - "http://localhost:9000"
        allowedMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowedHeaders: "*"
        allowCredentials: true
        maxAge: 3600  # Cache preflight response in 1 hour
